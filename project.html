<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicare Portal</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar-brand{
            background-color:blueviolet;
        }
        /* Section styles */
        #stock-section {
            display: none;
            margin: 20px;
            padding: 15px;
            border: 1px solid #aaa;
            background: #fff;
            border-radius: 8px;
        }
        .notification-alert {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .alert-expiry {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        .alert-stock {
            background-color: #f8d7da;
            border-left-color: #dc3545;
        }
        /* details-section removed; details now shown inside #details-container within stock section */
        /* Table styles */
        .table-responsive {
            margin-bottom: 1rem;
        }
        /* Content container */
        .content-area {
            padding: 20px;
            min-height: calc(100vh - 150px);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-info">
        <div class="container-fluid">
        <a class="navbar-brand" href="#">Medical store Portal</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><button class="btn btn-info nav-link" onclick="clearScreen()">Clear Screen</button></li>
            <li class="nav-item"><button id="login-btn" class="btn btn-info nav-link">Login</button></li>
                <li class="nav-item"><button id="stock-btn" class="btn btn-info nav-link">Stock</button></li>
                <li class="nav-item"><button id="add-medicine-btn" class="btn btn-info nav-link">Add Medicine</button></li>
            <li class="nav-item"><button id="dispense-btn" class="btn btn-info nav-link">Dispense</button></li>
            <li class="nav-item"><button id="notification-btn" class="btn btn-info nav-link">Notification</button></li>
            <li class="nav-item"><button id="report-btn" class="btn btn-info nav-link">Report</button></li>
            <li class="nav-item"><button id="logout-btn" class="btn btn-danger nav-link" style="display:none;">Logout</button></li>
            </ul>

            <form class="d-flex" role="search">
            <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-light" type="submit">Search</button>
            </form>
        </div>
        </div>
    </nav>
    <style>
        #medicine-form.simple {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 420px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        padding: 18px;
        z-index: 1050;
        display: none;
        }
        #medicine-form.simple h3 { margin-top: 0; }
        #medicine-form-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.35);
        display: none;
        z-index: 1040;
        }
        .simple-input { margin-bottom: 10px }
    </style>

    <div id="medicine-form-backdrop" onclick="hideMedicineForm()"></div>
    <div id="medicine-form" class="simple">
        <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="mb-0">Add Medicine</h3>
        <button class="btn btn-sm btn-outline-secondary" onclick="hideMedicineForm()">Close</button>
        </div>
        <form id="add-med-form" onsubmit="event.preventDefault(); addMedicine();">
        <input id="medicine-name" type="text" class="form-control simple-input" placeholder="Medicine name" required>
        <input id="batch-number" type="text" class="form-control simple-input" placeholder="Batch number" required>
        <input id="expiry-date" type="date" class="form-control simple-input" required>
        <input id="brand" type="text" class="form-control simple-input" placeholder="Brand" required>
        <input id="supplier" type="text" class="form-control simple-input" placeholder="Supplier" required>
        <input id="quantity" type="number" min="1" value="1" class="form-control simple-input" required>
        <div class="d-flex justify-content-end">
            <button class="btn btn-primary" type="submit">Add</button>
        </div>
        </form>
    </div>

    <div id="dispense-backdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1040;" onclick="hideDispenseForm()"></div>
    <div id="dispense-form" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:420px; background:#fff; padding:16px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.12); z-index:1050;">
        <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">Dispense Medicine</h4>
        <button class="btn btn-sm btn-outline-secondary" onclick="hideDispenseForm()">Close</button>
        </div>

        <form id="dispense-med-form" onsubmit="event.preventDefault(); dispenseMedicine();">
        <select id="dispense-select" class="form-select simple-input" required>
            <option value="">-- choose medicine --</option>
        </select>
        <input id="patient-name" type="text" class="form-control simple-input" placeholder="Patient name" required>
        <input id="dispense-quantity" type="number" min="1" value="1" class="form-control simple-input" required>

        <div class="d-flex justify-content-end">
            <button class="btn btn-primary" type="submit">Dispense</button>
        </div>
        </form>
    </div>
    
    <div id="login-modal-backdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1040;" onclick="hideLogin()"></div>
    <div id="login-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:360px; background:#fff; padding:16px; border-radius:8px; box-shadow:0 8px 24px rgba(0,0,0,0.12); z-index:1050;">
        <h4>Login</h4>
        <form id="login-form" onsubmit="event.preventDefault(); loginUser();">
        <input id="login-id" class="form-control simple-input" placeholder="User ID" required value="admin" readonly>
        <input id="login-pass" type="password" class="form-control simple-input" placeholder="Password" required>
        <div class="d-flex justify-content-between">
            <button class="btn btn-primary" type="submit">Login</button>
        </div>
        </form>
    </div>

    <div id="stock-section">
        <h2>üì¶ Medicine Stock</h2>
        <div class="table-responsive">
            <table id="stock-table" class="table table-striped table-bordered">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Batch</th>
                    <th>Expiry</th>
                    <th>Brand</th>
                    <th>Supplier</th>
                    <th>Quantity</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="stock-body"></tbody>
            </table>
        </div>
        <!-- Activity details moved here (report area) -->
        <div id="details-container" style="display:none; margin-top:20px;">
            <h2>üìù Activity Details (Report)</h2>
            <div class="mb-2">
                <button id="clear-history-btn" class="btn btn-sm btn-danger">Clear History</button>
            </div>
            <div class="table-responsive">
                <table id="history-table" class="table table-sm table-hover">
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>Type</th>
                        <th>Medicine</th>
                        <th>Batch</th>
                        <th>Qty</th>
                        <th>Person</th>
                        <th>Time</th>
                    </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>


    <footer id="footer-info" style="position:fixed; left:0; right:0; bottom:0; background:#f8f9fa; border-top:1px solid #ddd; padding:10px 16px; z-index:1060;">
        <div id="footer-message">Ready</div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Global error catcher: display errors in footer and send to server for logging
            window.addEventListener('error', function (event) {
                try {
                    const msg = event.message + ' at ' + event.filename + ':' + event.lineno + ':' + event.colno;
                    document.getElementById('footer-message').innerText = 'JS Error: ' + msg;
                    // best-effort send to server for inspection
                    fetch('http://localhost:5000/api/debug', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'error', message: msg, stack: event.error ? (event.error.stack || '') : '' })
                    }).catch(()=>{});
                } catch (e) { /* ignore */ }
            });
            window.addEventListener('unhandledrejection', function (ev) {
                try {
                    const msg = (ev.reason && ev.reason.message) ? ev.reason.message : String(ev.reason);
                    document.getElementById('footer-message').innerText = 'UnhandledRejection: ' + msg;
                    fetch('http://localhost:5000/api/debug', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'unhandledrejection', message: msg, reason: ev.reason })
                    }).catch(()=>{});
                } catch (e) {}
            });

            let loggedIn = false;    
            let medicines = [];
            let history = [];
                // stockIn variable removed
            // Fixed admin credentials
            const ADMIN_ID = "admin";
            const ADMIN_PASSWORD = "admin123";
            
            // Load initial data from SQL Server through our API
            async function loadData() {
                try {
                    console.log("Loading data from server...");
                    // Load medicines
                    const medResponse = await fetch('http://localhost:5000/api/medicines');
                    if (!medResponse.ok) {
                        throw new Error(`Failed to load medicines: ${medResponse.status} ${medResponse.statusText}`);
                    }
                    medicines = await medResponse.json();
                    console.log("Loaded medicines:", medicines);
                    
                    // Load history
                    const histResponse = await fetch('http://localhost:5000/api/history');
                    if (!histResponse.ok) {
                        throw new Error(`Failed to load history: ${histResponse.status} ${histResponse.statusText}`);
                    }
                    history = await histResponse.json();
                    console.log("Loaded history:", history);

                        // Stock-in data loading removed
                    
                    // Update the UI
                    if (document.getElementById('stock-section').style.display === 'block') {
                        showStock();
                    }
                    if (document.getElementById('details-container') && document.getElementById('details-container').style.display === 'block') {
                        showDetails();
                    }

                    document.getElementById('footer-message').innerHTML = '‚úÖ Data loaded successfully';
                } catch(e) { 
                    console.error('Load error:', e);
                    document.getElementById('footer-message').innerHTML = `‚ö†Ô∏è Error: ${e.message}`;
                }
            }
            
            // Load data and show stock section by default
            window.onload = async () => {
                try {
                    hideAllSections();
                    document.getElementById('stock-section').style.display = 'block';
                    await loadData();
                    showStock();
                    document.getElementById('footer-message').innerHTML = 'Ready';
                } catch (error) {
                    console.error('Error during initialization:', error);
                    document.getElementById('footer-message').innerHTML = '‚ö†Ô∏è Error loading initial data';
                }
            };

        // Initialize button handlers
        document.getElementById('login-btn').onclick = () => {
            showLogin();
        };
        document.getElementById('logout-btn').onclick = () => {
            loggedIn = false;
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('login-btn').style.display = 'inline';
            alert("üö™ Logged out");
        };
        function showLogin(){ document.getElementById('login-modal').style.display='block'; document.getElementById('login-modal-backdrop').style.display='block'; }
        function hideLogin(){ document.getElementById('login-modal').style.display='none'; document.getElementById('login-modal-backdrop').style.display='none'; }
        function loginUser(){
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value;
            if(id !== ADMIN_ID || pass !== ADMIN_PASSWORD){ 
                alert('Invalid password'); 
                return; 
            }
            loggedIn = true;
            document.getElementById('logout-btn').style.display = 'inline';
            document.getElementById('login-btn').style.display = 'none';
            hideLogin();
            document.getElementById('footer-message').innerText = `Logged in as ${id}`;
        }   

        document.getElementById('add-medicine-btn').onclick = async () => {
            if (!loggedIn) {
                alert('‚ö† Please login first');
                return;
            }
            hideAllSections();
            showMedicineForm();
        };
        
        // Tab button handlers
        document.getElementById('stock-btn').onclick = async () => {
            try {
                hideAllSections();
                document.getElementById('stock-section').style.display = 'block';
                document.getElementById('footer-message').innerText = 'Loading stock data...';
                await loadData();
                showStock();
                document.getElementById('footer-message').innerText = 'Viewing current stock';
            } catch (error) {
                console.error('Error loading stock:', error);
                document.getElementById('footer-message').innerHTML = '‚ö†Ô∏è Error: ' + error.message;
            }
        };

        document.getElementById('dispense-btn').onclick = async () => {
            if (!loggedIn) { 
                alert('‚ö† Please login first'); 
                return; 
            }
            // Refresh data before showing dispense form
            try {
                await loadData();
                hideAllSections();
                if (medicines.length === 0) {
                    alert('‚ö† No medicines available to dispense');
                    document.getElementById('stock-section').style.display = 'block';
                    return;
                }
                showDispenseForm();
                document.getElementById('footer-message').innerText = 'Dispensing medicine';
            } catch (error) {
                console.error('Error loading medicines:', error);
                alert('‚ö† Error loading medicines');
            }
        };

        function checkNotifications() {
            const notifications = [];
            const today = new Date();
            
            // Check expiry dates
            medicines.forEach(med => {
                const expiryDate = new Date(med.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntilExpiry <= 10 && daysUntilExpiry > 0) {
                    notifications.push(`‚ö†Ô∏è Medicine "${med.name}" (Batch: ${med.batch}) will expire in ${daysUntilExpiry} days`);
                } else if (daysUntilExpiry <= 0) {
                    notifications.push(`üö´ Medicine "${med.name}" (Batch: ${med.batch}) has EXPIRED!`);
                }
                
                // Check stock levels
                if (med.quantity <= 10) {
                    notifications.push(`üìâ Low stock alert: "${med.name}" has only ${med.quantity} units remaining`);
                }
            });
            
            return notifications;
        }

        document.getElementById('notification-btn').onclick = async () => {
            if (!loggedIn) { 
                alert('‚ö† Please login first'); 
                return; 
            }
            hideAllSections();
            await loadData(); // Refresh data before checking notifications
            
            // Create or get notification container
            let notificationContainer = document.getElementById('notification-container');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.id = 'notification-container';
                notificationContainer.style.margin = '20px';
                document.body.appendChild(notificationContainer);
            }

            const today = new Date();
            const notifications = [];

            // Check each medicine for expiry and stock alerts
            medicines.forEach(med => {
                const expiryDate = new Date(med.expiry);
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                // Check expiry date (10 days warning)
                if (daysUntilExpiry <= 10 && daysUntilExpiry > 0) {
                    notifications.push({
                        type: 'warning',
                        icon: '‚ö†Ô∏è',
                        message: `Medicine "${med.name}" (Batch: ${med.batch}) will expire in ${daysUntilExpiry} days`
                    });
                }
                
                // Check stock level (10 units warning)
                if (med.quantity <= 10) {
                    notifications.push({
                        type: 'danger',
                        icon: 'üìâ',
                        message: `Low stock alert: Only ${med.quantity} units of "${med.name}" remaining`
                    });
                }
            });

            // Display notifications with a nice UI
            notificationContainer.style.display = 'block';
            notificationContainer.innerHTML = `
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">üì¨ Notifications</h4>
                        <span class="badge bg-light text-dark">${notifications.length} Alert(s)</span>
                    </div>
                    <div class="card-body">
                        ${notifications.length === 0 
                            ? '<div class="alert alert-success">‚úÖ No alerts at this time</div>'
                            : notifications.map(notif => `
                                <div class="alert alert-${notif.type === 'warning' ? 'warning' : 'danger'} mb-2 d-flex align-items-center">
                                    <div class="me-2">${notif.icon}</div>
                                    <div>${notif.message}</div>
                                </div>
                            `).join('')}
                    </div>
                    <div class="card-footer text-muted small">
                        Last checked: ${new Date().toLocaleString()}
                    </div>
                </div>
            `;

            document.getElementById('footer-message').innerText = `${notifications.length} notification(s) found`;
        };

        document.getElementById('report-btn').onclick = async () => {
            try {
                await loadData();
                hideAllSections();
                // Show stock and the embedded details/report container
                document.getElementById('stock-section').style.display = 'block';
                const dc = document.getElementById('details-container');
                if (dc) dc.style.display = 'block';
                showDetails();
                document.getElementById('footer-message').innerText = 'Viewing activity report';
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('footer-message').innerHTML = '‚ö†Ô∏è Error loading report data';
            }
        };

    
        function hideAllSections() {
            // Hide all content sections
            document.getElementById('stock-section').style.display = 'none';
            const dc = document.getElementById('details-container');
            if (dc) dc.style.display = 'none';
            // Hide notifications section if it exists
            const notifyDiv = document.getElementById('notifications-section');
            if (notifyDiv) notifyDiv.style.display = 'none';
            // Hide all modals/forms
            hideMedicineForm();
            hideDispenseForm();
            document.getElementById('dispense-form').style.display = 'none';
        }
        
        function clearScreen() {
            document.getElementById('footer-message').innerHTML = 'Ready';
            hideAllSections();
            // Show stock section by default
            document.getElementById('stock-section').style.display = 'block';
            showStock();
        }
        async function addMedicine() {
            const newMedicineName = document.getElementById('medicine-name').value;
            const newBatchNumber = document.getElementById('batch-number').value;
            const newExpiryDate = document.getElementById('expiry-date').value;
            const newBrand = document.getElementById('brand').value;
            const newSupplier = document.getElementById('supplier').value;
            const newQuantity = parseInt(document.getElementById('quantity').value, 10);
            
            if (!newMedicineName || !newBatchNumber || !newExpiryDate || !newBrand || !newSupplier) {
                alert("‚ö† Please fill all fields");
                return;
            }
            if (!newQuantity || newQuantity < 1) {
                alert('‚ö† Quantity must be a number greater than 0');
                return;
            }

            try {
                console.log("Sending medicine data:", {
                    name: newMedicineName,
                    batch: newBatchNumber,
                    expiry: newExpiryDate,
                    brand: newBrand,
                    supplier: newSupplier,
                    quantity: newQuantity
                });
                
                const response = await fetch('http://localhost:5000/api/medicines', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newMedicineName,
                        batch: newBatchNumber,
                        expiry: newExpiryDate,
                        brand: newBrand,
                        supplier: newSupplier,
                        quantity: newQuantity
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to add medicine');
                }

                const output = `‚úÖ Added Medicine: <b>${newMedicineName}</b>, Batch: ${newBatchNumber}, Expiry: ${newExpiryDate}, Brand: ${newBrand}, Supplier: ${newSupplier}, Quantity: ${newQuantity}`;
                document.getElementById('footer-message').innerHTML = output;
                
                // Clear form first
                document.getElementById('medicine-name').value = "";
                document.getElementById('batch-number').value = "";
                document.getElementById('expiry-date').value = "";
                document.getElementById('brand').value = "";
                document.getElementById('supplier').value = "";
                document.getElementById('quantity').value = "1";
                
                // Reload data and close form
                await loadData();
                
                hideMedicineForm();
                hideAllSections();
                document.getElementById('stock-section').style.display = 'block';
                showStock();
            } catch (error) {
                console.error('Error adding medicine:', error);
                alert('Failed to add medicine: ' + error.message);
            }
        }

        
        function showStock() {
            console.log("Showing stock. Available medicines:", medicines);
            const tbody = document.getElementById('stock-body');
            tbody.innerHTML = '';
            if (!medicines || medicines.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center">‚ö† No medicines added yet</td></tr>`;
                return;
            }
            
            medicines.forEach((med) => {
                tbody.innerHTML += `
                <tr>
                    <td>${med.id}</td>
                    <td>${med.name}</td>
                    <td>${med.batch}</td>
                    <td>${med.expiry}</td>
                    <td>${med.brand}</td>
                    <td>${med.supplier}</td>
                    <td>${med.quantity ?? 0}</td>
                    <td class="text-nowrap">
                    <button class="btn btn-sm btn-danger" onclick="deleteMedicine(${med.id})">‚ùå Delete</button>
                    </td>
                </tr>
                `;
            });
        }

        async function deleteMedicine(id) {
            if (confirm("Are you sure you want to delete this medicine?")) {
                try {
                    const response = await fetch(`http://localhost:5000/api/medicines/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to delete medicine');
                    }
                    
                    // Reload data from server
                    await loadData();
                    showStock();
                } catch (error) {
                    alert('Failed to delete medicine: ' + error.message);
                }
            }
        }
        function showDispenseForm() {
            // Get fresh data first
            const select = document.getElementById('dispense-select');
            select.innerHTML = '<option value="">-- choose medicine --</option>';
            medicines.forEach(m => {
                if (m.quantity > 0) {  // Only show medicines with stock
                    select.innerHTML += `<option value="${m.id}">${m.name} (Batch: ${m.batch}) ‚Äî Available: ${m.quantity}</option>`;
                }
            });
            
            // Reset form
            document.getElementById('patient-name').value = '';
            document.getElementById('dispense-quantity').value = '1';
            
            // Show form
            document.getElementById('dispense-backdrop').style.display = 'block';
            document.getElementById('dispense-form').style.display = 'block';
        }
        
        function hideDispenseForm() {
            document.getElementById('dispense-backdrop').style.display = 'none';
            document.getElementById('dispense-form').style.display = 'none';
        }
        
        async function dispenseMedicine() {
            if (!loggedIn) {
                alert('‚ö† Please login first');
                return;
            }
            
            // Get form values
            const medicineId = document.getElementById('dispense-select').value;
            const patient = document.getElementById('patient-name').value.trim();
            const qty = document.getElementById('dispense-quantity').value;
            
            console.log('Dispense form values:', { medicineId, patient, qty });
            
            // Validate form values
            if (!medicineId) { 
                alert('‚ö† Please select a medicine'); 
                return; 
            }
            if (!patient) { 
                alert('‚ö† Please enter patient name'); 
                return; 
            }
            if (!qty || parseInt(qty) < 1) { 
                alert('‚ö† Quantity must be 1 or more'); 
                return; 
            }
            
            try {
                // Find medicine details first to check quantity
                const med = medicines.find(m => m.id === parseInt(medicineId));
                if (!med) {
                    alert('‚ö† Medicine not found');
                    return;
                }
                if (med.quantity < parseInt(qty)) {
                    alert(`‚ö† Not enough stock. Available: ${med.quantity}`);
                    return;
                }
                
                const response = await fetch('http://localhost:5000/api/dispense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        medicine_id: medicineId,
                        quantity: qty,
                        patient: patient
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to dispense medicine');
                }
                
                const out = `ü©∫ Dispensed ${qty} x ${med.name} to ${patient}. Operation successful.`;
                document.getElementById('footer-message').innerHTML = out;
                
                // Clear form
                document.getElementById('dispense-select').value = "";
                document.getElementById('patient-name').value = "";
                document.getElementById('dispense-quantity').value = "1";
                
                // Reload data from server
                await loadData();
                
                hideDispenseForm();
                hideAllSections();
                document.getElementById('stock-section').style.display = 'block';
                showStock();
            } catch (error) {
                console.error('Error dispensing medicine:', error);
                alert('Failed to dispense medicine: ' + error.message);
            }
        }

        // Since we're using a database, we don't need these functions anymore
        function saveData() {
            // Data is saved through API calls now
        }
        function recordHistory(entry) {
            // History is recorded through API calls now
            loadData(); // Reload to get updated history
        }
        function showDetails(){
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';
            // Ensure details container is visible
            const detailsContainer = document.getElementById('details-container');
            if (detailsContainer) detailsContainer.style.display = 'block';

            // summary for report
            const summaryElId = 'report-summary';
            let summaryEl = document.getElementById(summaryElId);
            if (!summaryEl) {
                summaryEl = document.createElement('div');
                summaryEl.id = summaryElId;
                summaryEl.className = 'mb-3';
                // insert summary at the top of details container
                if (detailsContainer && detailsContainer.firstChild) {
                    detailsContainer.insertBefore(summaryEl, detailsContainer.firstChild.nextSibling);
                }
            }

            const totalItems = medicines.length;
            const totalQuantity = medicines.reduce((acc, m) => acc + (Number(m.quantity) || 0), 0);
            summaryEl.innerHTML = `<strong>Stock summary:</strong> ${totalItems} item(s), ${totalQuantity} total units`;
            if (!history.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No history yet</td></tr>';
                return;
            }
            history.forEach((h, i) => {
                tbody.innerHTML += `
                <tr>
                    <td>${i+1}</td>
                    <td>${h.type}</td>
                    <td>${h.medicine_name || ''}</td>
                    <td>${h.batch || ''}</td>
                    <td>${h.quantity || ''}</td>
                    <td>${h.person || ''}</td>
                    <td>${new Date(h.timestamp).toLocaleString()}</td>
                </tr>
                `;
            });
        }
        
        document.getElementById('clear-history-btn').onclick = async () => {
            if (!confirm('Clear all history?')) return;
            try {
                const response = await fetch('http://localhost:5000/api/history/clear', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to clear history');
                }
                
                await loadData(); // Reload data from server
                showDetails();
                document.getElementById('footer-message').innerText = 'History cleared';
            } catch (error) {
                alert('Failed to clear history: ' + error.message);
            }
        };
        function showMedicineForm() {
            const form = document.getElementById('medicine-form');
            const backdrop = document.getElementById('medicine-form-backdrop');
            form.style.display = 'block';
            backdrop.style.display = 'block';
        }
        function hideMedicineForm() {
            const form = document.getElementById('medicine-form');
            const backdrop = document.getElementById('medicine-form-backdrop');
            form.style.display = 'none';
            backdrop.style.display = 'none';
        }
    </script>
</body>
</html>
